<?php
	session_start();
	if(!isset($_SESSION['flag'])) echo "<script>location.href='index.html'</script>"
?>
	<!DOCTYPE html>
	<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Kostay</title>
		<meta name="keywords" content="Download, Apartment, Premium, Real Estate, HMTL, Site Template, property, mortgage, CSS" />
		<meta name="description" content="Download Apartment - Premium Real Estate HMTL Site Template" />
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<link rel="icon" href="favicon.ico" type="image/x-icon">

		<!-- Bootstrap -->
		<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
		<!-- Font awesome styles -->
		<link rel="stylesheet" href="apartment-font/css/font-awesome.min.css">
		<!-- Custom styles -->
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,500,500italic,700,700italic&amp;subset=latin,latin-ext'>
		<link rel="stylesheet" type="text/css" href="css/plugins.css">
		<link rel="stylesheet" type="text/css" href="css/apartment-layout.css">
		<link rel="stylesheet" type="text/css" href="css/search_detail.css">
		<link rel="stylesheet" type="text/css" href="css/custom.css">
		<link id="skin" rel="stylesheet" type="text/css" href="css/apartment-colors-blue.css">
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">

		<!--sweetalert2-->
		<script src="js/sweetalert.min.js"></script>


		<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    th{
      background-color: rgb(55, 151, 221);
      color: white;
    }
      th, tr{
        text-align: center;
      }
      th, td{
        display: table-cell;
        font-size: 1em;
        vertical-align: middle !important;
      }
      .no-padding{
        padding: 0px !important;
      }
      .no-margin{
        margin: 0px !important;
      }
    </style>
	</head>

	<body>
		<div class="loader-bg"></div>
		<div id="wrapper">

			<!-- Page header -->
			<header>
				<div class="top-bar-wrapper">
					<div class="container top-bar">
						<div class="row">
							<div class="col-xs-5 col-sm-8">
								<div class="top-mail pull-left hidden-xs">
									<span class="top-icon-circle">
								<i class="fa fa-envelope fa-sm"></i>
							</span>
									<span class="top-bar-text">admin@koreatech.ac.kr</span>
								</div>
								<div class="top-phone pull-left hidden-xxs">
									<span class="top-icon-circle">
								<i class="fa fa-phone"></i>
							</span>
									<span class="top-bar-text">(0)-123-456-789</span>
								</div>
								<div class="top-localization pull-left hidden-sm hidden-md hidden-xs">
									<span class="top-icon-circle pull-left">
								<i class="fa fa-map-marker"></i>
							</span>
									<span class="top-bar-text">KOREA</span>
								</div>
							</div>
							<div class="col-xs-7 col-sm-4">
								<div class="top-social-last top-dark pull-right" data-toggle="tooltip" data-placement="bottom" title="Login/Register">
									<a class="top-icon-circle" href="#login-modal" data-toggle="modal">
										<i class="fa fa-lock"></i>
									</a>
								</div>

								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-facebook"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-twitter"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-google-plus"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-skype"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
					<!-- /.top-bar -->
				</div>
				<!-- /.Page top-bar-wrapper -->

				<?include("config/mypage_navbar.html");?>
			</header>


			<section class="section-light section-top-shadow" style="padding-top:50px;">
				<div class="container">
					<div class="row">
						<div class="col-xs-12 col-md-12">

							<div class="row">
								<div class="col-xs-12">
									<h1>객실 설정</h1>
									<div class="title-separator-primary margin-top-10"></div>
								</div>
							</div>


							<div class="row margin-top-10">
								<div class="col-xs-12">
									<blockquote>
										<p>운영자 회원 혜택. 하우스 별 객실관리 메뉴입니다.(추가 설명 작성) </p>
										<footer>각 객실에 대한 공실 정보를 등록하세요.</footer>
									</blockquote>
								</div>
							</div>

							<?
							 include 'server/dbconnect.php';
							 $query = "select * from house_main where user_id='".$_SESSION['id']."' order by register_time DESC, house_title ASC";
							 $result = mysqli_query($conn, $query);
							 while($row = mysqli_fetch_array($result)){
								 $query = "select sum(person), max(rent), min(rent) from house_rooms where house_id='".$row['house_id']."'";
								 $result2 = mysqli_query($conn, $query);
								 $row2 = mysqli_fetch_row($result2);
								 $query = "select room_id from house_rooms where house_id='".$row['house_id']."' order by room_id ASC";
								 $result3 = mysqli_query($conn, $query);
								 $row3 = mysqli_fetch_row($result3);
								 $query = "select count(*) from house_beds where room_id='".$row3[0]."' and `condition`!=3;";
								 $result4 = mysqli_query($conn, $query);
								 $row4 = mysqli_fetch_row($result4);
								 $query = "select min(vacant) from house_beds where room_id='".$row3[0]."' and `condition`=2;";
								 $result5 = mysqli_query($conn, $query);
								 $row5 = mysqli_fetch_row($result5);
							?>

							<div class="list-offer" style="margin-bottom: 30px;">
								<!-- Item 사진 -->
								<div class="list-offer-left">

									<div class="list-offer-front">
										<div class="list-offer-photo height-100">
											<img src="images/tmpgrid-offer1.jpg" alt="" class="height-100" />
										</div>
									</div>

									<div class="list-offer-back">
										<div id="list-map1" class="list-offer-map">
										</div>
									</div>

								</div>
								<!-- .Item 사진 -->

								<!-- Item 정보 -->
								<div class="list-offer-right-large">
									<div class="list-offer-text">
										<div class="clearfix"></div>


										<div class="row">
											<div class="list-offer-h4 col-sm-12 col-md-12">
												<i class="fa fa-home list-offer-localization hidden-xs"></i>
												<p class="list-offer-title" style="font-size:1.5em; font-weight:bold;">
													<?=$row['house_title']?>
												</p>
											</div>
										</div>

										<div class="row text-right search-price-div">
											<div class="col-sm-12 col-md-12">
												<span class="search-price">렌트비 : </span>
												<span class="mini-price"><?=$row2[2]?></span>
												&nbsp;&nbsp;~&nbsp;&nbsp;
												<span class="max-price"><?=$row2[1]?></span>
											</div>
										</div>

										<div class="row margin-top-10">

											<div class="col-xs-12 col-lg-4 col-sm-4 col-md-4 text-left fixed-middle">
												<p style="font-size:1.4em;">
													룸&nbsp;&nbsp;&nbsp;&nbsp;
													<i class="fa fa-bed"></i>&nbsp;&nbsp;&nbsp;&nbsp;
													<?=$row['number_of_rooms']?>
												</p>
											</div>
											<div class="col-xs-12 col-lg-4 col-sm-4 col-md-4 text-left fixed-middle">
												<p style="font-size:1.4em;">
													정원&nbsp;&nbsp;&nbsp;&nbsp;
													<i class="fa fa-users"></i>&nbsp;&nbsp;&nbsp;&nbsp;
													<?=$row2[0]?>
												</p>
											</div>
											<div class="col-xs-12 col-sm-4 col-md-4 col-md-4 text-left fixed-middle">
												<p class="title-negative-margin" style="font-size:1.4em; display:inline">
													<?=$row5[0]?> ~ 입주가능
												</p>
												<div class="title-separator-primary"></div>
											</div>

										</div>

										<div class="row margin-top-10">
											<div class="col-xs-12 col-sm-12 col-md-12 col-md-12 text-left fixed-middle">
												<a class="btn btn-lg btn-default" name="<?=$row['house_id']?>"
													onclick="javascript:getVacant(this)" style="border:2px solid; font-weight:bold; width:100%; cursor:pointer">
													 공실등록
												</a>
											</div>

										</div>

										<div class="clearfix"></div>
									</div>
								</div>
								<!-- .Item 정보 -->
								<div class="clearfix"></div>
							</div>
							<!-- .Item -->
							<?}?>

					<div class="offer-pagination margin-top-30">
						<?
						$query = "select * from house_main where user_id='".$_SESSION['id']."'";
						$result = mysqli_query($conn, $query);
						$count = mysqli_num_rows($result);
						if($count>0){
						?>
						<a href="#" class="prev"><i class="jfont">&#xe800;</i></a>
						<?for($i=1;$i<($count/8)+1;++$i){?>
						<a><?=$i?></a>
						<?}?>
						<a href="#" class="next"><i class="jfont">&#xe802;</i></a>
						<?}?>
						<div class="clearfix"></div>
					</div>


							<script>
							function updateCon(param){
								$.ajax({
		              url:"server/set_room.php",
		              type:"POST",
		              data:{
										condition : "con",
		                target:$(param).attr("name"),
										value:$(param).val()
		              },
		              success: function(data){},
		              error: function(){
		                swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
		              }
		            });
							}
							function updateDay(param){
								$.ajax({
		              url:"server/set_room.php",
		              type:"POST",
		              data:{
										condition : "day",
		                target:$(param).attr("name"),
										value:$(param).val()
		              },
		              success: function(data){},
		              error: function(){
		                swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
		              }
		            });
							}
							function getVacant(param){
								$(".table-responsive").remove();
								var st = $(param).parent().parent().parent().parent().parent();
								$.ajax({
									url:"server/set_room.php",
									type:"POST",
									data:{
										condition : "get",
										house_id : $(param).attr("name")
									},
									success: function(data){
										var obj = JSON.parse(data);
										var table = "<div class='table-responsive margin-top-30'><table class='table'><tr ><th >구분</th><th >침대번호</th><th >성별</th><th >입주상황</th><th >공실예정일</th></tr><tr>";
										var current = 0;
												for(var i=0; i<obj[0].length;){
													var isFirst = true;
													current=i;
													for(var j=i; j<(Number(obj[1][i])+current); ++j){

														if(isFirst){
															table+="<td  rowspan='"+obj[1][j]+"'>"+obj[1][j]+"인실</td>";
															isFirst = false;
														}
														var day;

														table = table + "<td >"+obj[2][j]+"</td><td >"+obj[3][j]+"</td><td ><select onchange='javascript:updateCon(this)' name='"+obj[0][j]+"' class='bootstrap-select'><option selected disabled>현재상태: "+obj[4][j]+"</option><option value='1'>만실</option><option value='2'>공실 예정</option><option value='3'>공실</option></select></td><td ><input onchange='javascript:updateDay(this)' name='"+obj[0][j]+"' type='date' value='";
														if(obj[5][j]==null);
														else table+= obj[5][j];
														table +="' /> </td></tr>";
													}
													i+=Number(obj[1][i]);
												}


										table +='</table></div>';

										$(st).append(table).hide().fadeIn(500);
										$(st).trigger("create");

									},
									error: function(){}
								});


							}
							</script>
						</div>

					</div>
				</div>
			</section>

			<!--small footer-->
			<?include("config/footer.html")?>
			
		</div>

		<!-- Move to top button -->

		<div class="move-top">
			<div class="big-triangle-second-color"></div>
			<div class="big-icon-second-color"><i class="jfont fa-lg">&#xe803;</i></div>
		</div>

		<!--로그인, 회원가입, 비밀번호 찾기-->
		<?include("config/user.html")?>
		<!--sweetalert2-->
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">
		<script src="js/sweetalert.min.js"></script>

		<!-- jQuery  -->
		<script type="text/javascript" src="js/jQuery/jquery.min.js"></script>
		<script type="text/javascript" src="js/jQuery/jquery-ui.min.js"></script>

		<!-- Bootstrap-->
		<script type="text/javascript" src="bootstrap/bootstrap.min.js"></script>

		<!-- Google Maps -->
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDfDCV5hXiPamCIT8_vwGXuzimLQ9MF76g&amp;sensor=false&amp;libraries=places"></script>

		<!-- plugins script -->
		<script type="text/javascript" src="js/plugins.js"></script>

		<!-- template scripts -->
		<script type="text/javascript" src="mail/validate.js"></script>
		<script type="text/javascript" src="js/apartment.js"></script>

	</body>

	</html>
