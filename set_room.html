<?php
	session_start();
	if(!isset($_SESSION['flag'])) echo "<script>location.href='index.html'</script>"
?>
	<!DOCTYPE html>
	<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Kostay</title>
		<meta name="keywords" content="Download, Apartment, Premium, Real Estate, HMTL, Site Template, property, mortgage, CSS" />
		<meta name="description" content="Download Apartment - Premium Real Estate HMTL Site Template" />
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<link rel="icon" href="favicon.ico" type="image/x-icon">

		<!-- Bootstrap -->
		<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
		<!-- Font awesome styles -->
		<link rel="stylesheet" href="apartment-font/css/font-awesome.min.css">
		<!-- Custom styles -->
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,500,500italic,700,700italic&amp;subset=latin,latin-ext'>
		<link rel="stylesheet" type="text/css" href="css/plugins.css">
		<link rel="stylesheet" type="text/css" href="css/apartment-layout.css">
		<link rel="stylesheet" type="text/css" href="css/search_detail.css">
		<link rel="stylesheet" type="text/css" href="css/custom.css">
		<link id="skin" rel="stylesheet" type="text/css" href="css/apartment-colors-blue.css">
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">

		<!--sweetalert2-->
		<script src="js/sweetalert.min.js"></script>
		<script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>


		<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    th{
      background-color: rgb(55, 151, 221);
      color: white;
    }
      th, tr{
        text-align: center;
      }
      th, td{
        display: table-cell;
        font-size: 1em;
        vertical-align: middle !important;
      }
      .no-padding{
        padding: 0px !important;
      }
      .no-margin{
        margin: 0px !important;
      }
			body, html {
    height:100%;
    width:100%;
    min-height:100%;
    padding:0;
    margin:0;
		}
		.error {
		    width:200px;
		    height:20px;
		    height:auto;
		    position:absolute;
		    left:50%;
		    margin-left:-100px;
		    bottom:10px;
		    background-color: #383838;
		    color: #F0F0F0;
		    font-family: Calibri;
		    font-size: 20px;
		    padding:10px;
		    text-align:center;
		    border-radius: 2px;
		    -webkit-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
		    -moz-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
		    box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
		}
    </style>
    <style media="screen">
			.adv-search-section {
				height: 40vh;
			}
			.item-row{
				border:  1px solid rgba(226, 226, 226, 0.72);
				cursor: pointer;
				margin-bottom: 20px;
			}
			.list-img{
				width: 40% !important;
				height: auto;
				margin: 5px;
				max-width: 25px;
				max-height: 25px;
			}
			.icon-contanier{
				color: white;
				font-size: 1.5em;
			}
			.resize-icon-container{
				display: inline;
				position: relative;
			}

			@media (max-width: 600px) {
				.resize-icon-container{
  				left: 25%;
  			}
			}


			.icon-contanier span{
				margin-left: 10%;
				font-size: 1em;
				margin-top: 3px;
				position: relative;
				top: 3px;
			}
			h5{
				margin-bottom: 25px;
			}
		</style>
		<style media="screen">
			.adv-search-section {
				height: 40vh;
			}
			.item-row{
				border:  1px solid rgba(226, 226, 226, 0.72);
				cursor: pointer;
				margin-bottom: 20px;
			}
			.list-img{
				width: 40% !important;
				height: auto;
				margin: 5px;
				max-width: 25px;
				max-height: 25px;
			}
			.icon-contanier{
				color: white;
				font-size: 1.5em;
			}
			.resize-icon-container{
				display: inline;
				position: relative;
			}

			@media (max-width: 600px) {
				.resize-icon-container{
  				left: 25%;
  			}
			}


			.icon-contanier span{
				margin-left: 10%;
				font-size: 1em;
				margin-top: 3px;
				position: relative;
				top: 3px;
			}
			h5{
				margin-bottom: 25px;
			}
             .desc-default-option-title{
                    margin: 0px;
                    display: block;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    height: 50px;
                    font-weight: bold;
            }
            .desc-default-option{
                    margin: 0px;
                    display: -webkit-box; 
                    -webkit-line-clamp: 3;
                    text-overflow: ellipsis; 
                    overflow: hidden;
                    -webkit-box-orient: vertical;
            }
		</style>
	</head>

	<body>
		<div class="loader-bg"></div>
		<div id="wrapper">

			<!-- Page header -->
			<header>
				<div class="top-bar-wrapper">
					<div class="container top-bar">
						<div class="row">
							<div class="col-xs-5 col-sm-8">
								<div class="top-mail pull-left hidden-xs">
									<span class="top-icon-circle">
								<i class="fa fa-envelope fa-sm"></i>
							</span>
									<span class="top-bar-text">admin@koreatech.ac.kr</span>
								</div>
								<div class="top-phone pull-left hidden-xxs">
									<span class="top-icon-circle">
								<i class="fa fa-phone"></i>
							</span>
									<span class="top-bar-text">(0)-123-456-789</span>
								</div>
								<div class="top-localization pull-left hidden-sm hidden-md hidden-xs">
									<span class="top-icon-circle pull-left">
								<i class="fa fa-map-marker"></i>
							</span>
									<span class="top-bar-text">KOREA</span>
								</div>
							</div>
							<div class="col-xs-7 col-sm-4">
								<div class="top-social-last top-dark pull-right" data-toggle="tooltip" data-placement="bottom" title="Login/Register">
									<a class="top-icon-circle" href="#login-modal" data-toggle="modal">
										<i class="fa fa-lock"></i>
									</a>
								</div>

								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-facebook"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-twitter"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-google-plus"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-skype"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
					<!-- /.top-bar -->
				</div>
				<!-- /.Page top-bar-wrapper -->

				<?include("config/mypage_navbar.html");?>
			</header>


			<section class="section-light section-top-shadow" style="padding-top:50px;">
				<div class="container">
					<div class="row">
						<div class="col-xs-12 col-md-12">

							<div class="row">
								<div class="col-xs-12">
									<h1>객실 설정</h1>
									<div class="title-separator-primary margin-top-10"></div>
								</div>
							</div>


							<div class="row margin-top-10">
								<div class="col-xs-12">
									<blockquote>
										<p>각 객실의 공실 관련 정보를 등록하세요</p>
									</blockquote>
								</div>
							</div>

							<?
							 include 'server/dbconnect.php';
							 $query = "select * from house_main where user_id='".$_SESSION['id']."' order by register_time DESC, house_title ASC";
							 $result = mysqli_query($conn, $query);
							 while($row = mysqli_fetch_array($result)){
								 $query = "select sum(person), max(rent), min(rent) from house_rooms where house_id='".$row['house_id']."'";
										 $result2 = mysqli_query($conn, $query);
										 $row2 = mysqli_fetch_row($result2);
										$titleQuery="select house_title,number_of_rooms, facilities,number_of_toilet from house_main where house_id='".$row['house_id']."'";
										$titleResult=mysqli_query($conn,$titleQuery);
										$titleRow = mysqli_fetch_array($titleResult);
										$query = "select room_id from house_rooms where house_id='".$row['house_id']."' order by room_id ASC";
								 $result3 = mysqli_query($conn, $query);
								 $row3 = mysqli_fetch_row($result3);
										$query = "select min(vacant) from house_beds where room_id='".$row3[0]."' and `condition`=2;";
								 $result5 = mysqli_query($conn, $query);
								 $row5 = mysqli_fetch_row($result5);
                                $initQuery = "select * from search where house_id='".$row['house_id']."'";
                                       $initResult = mysqli_query($conn,$initQuery);
                                       $initRow = mysqli_fetch_array($initResult);
                                        $return = array();
                                        for($i=1;$i<9;$i++){
                                          $imagequery = "select * from house_main_image where email='".$row['house_id']."_".$i."'";
                                          $imageresult = mysqli_query($conn, $imagequery);
                                          if(mysqli_num_rows($imageresult)===1){
                                            $imagerow = mysqli_fetch_array($imageresult);
                                            array_push($return, $imagerow['img']);
                                          }
                                        }
							?>
                          <div class="set-container">  
                                <div class="row item-row" name="<?=$row['house_id']?>">
										<div class="col-sm-12 col-md-4 col-lg-3"  style="padding:0px;">
											<div class="list-offer-photo height-100" style="width:100%;">
												<img src="<?if(sizeof($return)>0){ echo 'server/'.$return[0]; } else{echo 'server/houses/noimg.jpg';}?>" alt="" style="height:182px; width:100%" />

												<div class="col-xs-12 icon-contanier" style="background-color:black; position:absolute; bottom:0px; width:100%">
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/icons/w_master.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$row2[0]?></span>
														</div>
													</div>
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/rooms-icon.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$titleRow['number_of_rooms']?></span>
														</div>
													</div>
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/icons/w_toilet.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$titleRow['number_of_toilet']?></span>
														</div>
													</div>
												</div>

											</div>
										</div>
                                        
                                        <style>
                                            .desc-default-option-title{
                                                    margin: 0px;
                                                    display: block;
                                                    white-space: nowrap;
                                                    overflow: hidden;
                                                    text-overflow: ellipsis;
                                                    height: 50px;
                                                    font-weight: bold;
                                            }
                                            .desc-default-option{
                                                    margin: 0px;
                                                    display: -webkit-box; 
                                                    -webkit-line-clamp: 3;
                                                    text-overflow: ellipsis; 
                                                    overflow: hidden;
                                                    -webkit-box-orient: vertical;
                                            }
                                        </style>
                                        
										<div class="col-sm-12 col-md-8 col-lg-9" style="padding:0px;">
											<div class="" style="padding-top:5px;">
												<div class="clearfix"></div>

												<div class="row">
													<div class="list-offer-h4 col-sm-12 col-md-12">
														<!--<strong><i class="fa fa-home list-offer-localization" style="font-size:1.4em;"></i></strong>-->
														<h4 class="list-offer-title title-default  desc-default-option-title" style="margin-bottom:10px !important;"><?=$titleRow['house_title']?></h4>
														<div class="clearfix"></div>

										<div class="row margin-top-10">
                                            <div class="col-sm-12 col-sm-4">
												<span class="search-price"  style="font-size:1.4em; color:#898989" >렌트비 : </span>
												<span class="mini-price" style="font-size:1.4em; color:#898989"><?=$initRow['min_rent']?></span>
												&nbsp;&nbsp;~&nbsp;&nbsp;
												<span class="max-price" style="font-size:1.4em; color:#898989"><?=$initRow['max_rent']?></span>
											</div>
											<div class="col-xs-12 col-lg-4 col-sm-4 col-md-4 text-left fixed-middle">
												<p style="font-size:1.4em; color:#898989">
													룸&nbsp;&nbsp;&nbsp;&nbsp;
													<i class="fa fa-bed"></i>&nbsp;&nbsp;&nbsp;&nbsp;
													<?=$row['number_of_rooms']?>
												</p>
											</div>
											<div class="col-xs-12 col-lg-4 col-sm-4 col-md-4 text-left fixed-middle">
												<p style="font-size:1.4em; color:#898989">
													정원&nbsp;&nbsp;&nbsp;&nbsp;
													<i class="fa fa-users"></i>&nbsp;&nbsp;&nbsp;&nbsp;
													<?=$row2[0]?>
												</p>
											</div>

										</div>

										<div class="row margin-top-10" style="margin-bottom:10px">
											<div class="col-xs-12 col-sm-12 col-md-12 col-md-12 text-left fixed-middle">
												<a class="btn btn-lg btn-default" name="<?=$row['house_id']?>"
													onclick="javascript:getVacant(this)" style="border:2px solid; font-weight:bold; width:100%; cursor:pointer">
													 공실등록
												</a>
											</div>

										</div>

										<div class="clearfix"></div>
													</div>
												</div>
											</div>
										</div>

										<div class="col-sm-12 col-md-3 col-lg-2" style="padding:0px">
											

										</div>
									</div>
                        </div>
							
							<!-- .Item -->
							<?}?>

					<div class="offer-pagination margin-top-30">
						<?
						$query = "select * from house_main where user_id='".$_SESSION['id']."'";
						$result = mysqli_query($conn, $query);
						$count = mysqli_num_rows($result);
						if($count>0){
						?>
						<a href="#" class="prev"><i class="jfont">&#xe800;</i></a>
						<?for($i=1;$i<($count/8)+1;++$i){?>
						<a><?=$i?></a>
						<?}?>
						<a href="#" class="next"><i class="jfont">&#xe802;</i></a>
						<?}?>
						<div class="clearfix"></div>
					</div>


							<script>
							function updateCon(param){
								$.ajax({
		              url:"server/set_room.php",
		              type:"POST",
		              data:{
										condition : "con",
		                target:$(param).attr("name"),
										value:$(param).val()
		              },
		              success: function(data){
										$(".loader-bg").fadeIn(200).fadeOut(200);
									},
		              error: function(){
		                swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
		              }
		            });
							}
							function updateDay(param){
								$.ajax({
		              url:"server/set_room.php",
		              type:"POST",
		              data:{
										condition : "day",
		                target:$(param).attr("name"),
										value:$(param).val()
		              },
		              success: function(data){
										$(".loader-bg").fadeIn(200).fadeOut(200);
									},
		              error: function(){
		                swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
		              }
		            });
							}
							function getVacant(param){
								$(".table-responsive").remove();
								var st = $(param).parent().parent().parent().parent().parent().parent().parent().parent();
								$.ajax({
									url:"server/set_room.php",
									type:"POST",
									data:{
										condition : "get",
										house_id : $(param).attr("name")
									},
									success: function(data){
										var obj = JSON.parse(data);
										var table = "<div class='table-responsive margin-top-30'><table class='table'><tr ><th >구분</th><th >침대번호</th><th >성별</th><th >입주상황</th><th >공실예정일</th></tr><tr>";
										var current = 0;
												for(var i=0; i<obj[0].length;){
													var isFirst = true;
													current=i;
                                                    var person = obj[1][i];
                                                    person = person.split(" ");
                                                    var tmp = person[0];
													for(var j=i; j<(Number(person[0])+current); ++j){
                                                        person = obj[1][j];
                                                        person = person.split(" ");
														if(isFirst){
															table+="<td  rowspan='"+person[0]+"'>"+person[0]+person[1]+"</td>";
															isFirst = false;
														}
														var day;

														table = table + "<td >"+obj[2][j]+"</td><td >"+obj[3][j]+"</td><td ><select onchange='javascript:updateCon(this)' name='"+obj[0][j]+"' class='bootstrap-select'><option selected disabled>현재상태: "+obj[4][j]+"</option><option value='1'>만실</option><option value='2'>공실 예정</option><option value='3'>공실</option></select></td><td ><input onchange='javascript:updateDay(this)' name='"+obj[0][j]+"' type='date' value='";
														if(obj[5][j]==null);
														else table+= obj[5][j];
														table +="' /> </td></tr>";
													}
													i+=Number(tmp);
												}


										table +='</table></div>';

										$(st).append(table).hide().fadeIn(500);
										$(st).trigger("create");

									},
									error: function(){}
								});


							}
							</script>
						</div>

					</div>
				</div>

			</section>

			<!--small footer-->
			<?include("config/footer.html")?>

		</div>

		<!-- Move to top button -->

		<div class="move-top">
			<div class="big-triangle-second-color"></div>
			<div class="big-icon-second-color"><i class="jfont fa-lg">&#xe803;</i></div>
		</div>

		<!--로그인, 회원가입, 비밀번호 찾기-->
		<?include("config/user.html")?>
		<!--sweetalert2-->
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">
		<script src="js/sweetalert.min.js"></script>

		<!-- jQuery  -->
		<script type="text/javascript" src="js/jQuery/jquery.min.js"></script>
		<script type="text/javascript" src="js/jQuery/jquery-ui.min.js"></script>

		<!-- Bootstrap-->
		<script type="text/javascript" src="bootstrap/bootstrap.min.js"></script>

		<!-- Google Maps -->
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDfDCV5hXiPamCIT8_vwGXuzimLQ9MF76g&amp;sensor=false&amp;libraries=places"></script>

		<!-- plugins script -->
		<script type="text/javascript" src="js/plugins.js"></script>

		<!-- template scripts -->
		<script type="text/javascript" src="mail/validate.js"></script>
		<script type="text/javascript" src="js/apartment.js"></script>

	</body>

	</html>
