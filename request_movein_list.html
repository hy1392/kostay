<?php
	session_start();
	if(!isset($_SESSION['flag'])) echo "<script>location.href='index.html'</script>"
?>
	<!DOCTYPE html>
	<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Kostay</title>
		<meta name="keywords" content="Download, Apartment, Premium, Real Estate, HMTL, Site Template, property, mortgage, CSS" />
		<meta name="description" content="Download Apartment - Premium Real Estate HMTL Site Template" />
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<link rel="icon" href="favicon.ico" type="image/x-icon">

		<!-- Bootstrap -->
		<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
		<!-- Font awesome styles -->
		<link rel="stylesheet" href="apartment-font/css/font-awesome.min.css">
		<!-- Custom styles -->
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,500,500italic,700,700italic&amp;subset=latin,latin-ext'>
		<link rel="stylesheet" type="text/css" href="css/plugins.css">
		<link rel="stylesheet" type="text/css" href="css/apartment-layout.css">
		<link rel="stylesheet" type="text/css" href="css/search_detail.css">
		<link rel="stylesheet" type="text/css" href="css/custom.css">
		<link id="skin" rel="stylesheet" type="text/css" href="css/apartment-colors-blue.css">

		<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

	</head>

	<body>
		<div class="loader-bg"></div>
		<div id="wrapper">
       
       <!-- accept modal -->
        <div class="modal fade apartment-modal" id="accept-modal" style="top:10%;" data-keyboard="false">
            <div class="modal-dialog" style="width :300px; height:278px;">
                <div class="modal-content" style="width :300px; height:278px; border:none">
                    <div class="modal-body" style="width :300px; height:278px; padding:0px;">
                        <div style="width:100%;height:100px;background-color:rgb(0,176,240);text-align:center;color:white;padding:25px 20px">
                            <span class="modal-date" style="font-size:18px;"></span>
                            <span style="font-size:18px;">부터</span>
                            <span class="modal-room" style="font-size:18px;"></span>
                            <span style="font-size:18px;">인실</span>
                            <span class="modal-add" style="font-size:18px;"></span>
                            <span style="font-size:18px;">호 공실예정 입니다.</span>
                        </div>
                        <div style="width:100%;height:64px;;text-align:center;color:black;font-size:18px; font-weight:bold">
                            <p style="margin:0px;padding-top:20px">입주하실래요?</p>
                        </div>
                        <div style="width:100%;height:64px;;text-align:center;color:black;font-size:18px; font-weight:bold">
                            <div class="col-xs-6 accept-yes" style="padding-top:20px; height:64px; border:1px solid rgb(0,176,240); cursor:pointer">예</div>
                            <div class="col-xs-6 accept-no" style="padding-top:20px; height:64px;border:1px solid rgb(0,176,240);cursor:pointer">아니오</div>
                        </div>
                        <div style="width:100%;height:50px;;text-align:center;color:black;text-align:left;font-size:12px;">
                            <p style="margin:0px; padding:8px 5px;line-height:1.3em">해당주택의 임대료, 입주조건 등은 다시 한 번 확인해 주세요.</p>
                        </div>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
       
        <!-- Page header -->
			<header>
				<div class="top-bar-wrapper">
					<div class="container top-bar">
						<div class="row">
							<div class="col-xs-5 col-sm-8">
								<div class="top-mail pull-left hidden-xs">
									<span class="top-icon-circle">
								<i class="fa fa-envelope fa-sm"></i>
							</span>
									<span class="top-bar-text">admin@koreatech.ac.kr</span>
								</div>
								<div class="top-phone pull-left hidden-xxs">
									<span class="top-icon-circle">
								<i class="fa fa-phone"></i>
							</span>
									<span class="top-bar-text">(0)-123-456-789</span>
								</div>
								<div class="top-localization pull-left hidden-sm hidden-md hidden-xs">
									<span class="top-icon-circle pull-left">
								<i class="fa fa-map-marker"></i>
							</span>
									<span class="top-bar-text">KOREA</span>
								</div>
							</div>
							<div class="col-xs-7 col-sm-4">
								<div class="top-social-last top-dark pull-right" data-toggle="tooltip" data-placement="bottom" title="Login/Register">
									<a class="top-icon-circle" href="#login-modal" data-toggle="modal">
										<i class="fa fa-lock"></i>
									</a>
								</div>

								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-facebook"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-twitter"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-google-plus"></i>
									</a>
								</div>
								<div class="top-social pull-right">
									<a class="top-icon-circle" href="#">
										<i class="fa fa-skype"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
					<!-- /.top-bar -->
				</div>
				<!-- /.Page top-bar-wrapper -->

				<?include("config/mypage_navbar.html");?>
			</header>


			<section class="section-light section-top-shadow">
				<div class="container">
					<div class="row">
						<div class="col-xs-12 col-md-9 col-md-push-3">
							<div class="row grid-offer-row" style="margin-top:0px;">

								<?
								include 'server/dbconnect.php';
								$query = "select * from user_movein_list where email='".$_SESSION['id']."' order by time DESC";
								$result = mysqli_query($conn, $query);
								while($row = mysqli_fetch_array($result)){
									$query = "select sum(person), max(rent), min(rent) from house_rooms where house_id='".$row['house_id']."'";
									$result2 = mysqli_query($conn, $query);
									$row2 = mysqli_fetch_row($result2);
									$query = "select room_id,house_id from house_rooms where house_id='".$row['house_id']."'";
									$result3 = mysqli_query($conn, $query);
									$row3 = mysqli_fetch_row($result3);
									$query = "select count(*) from house_beds where room_id='".$row3[0]."' and `condition`!=3;";
									$result4 = mysqli_query($conn, $query);
									$row4 = mysqli_fetch_row($result4);
									$query = "select min(vacant) from house_beds where room_id='".$row3[0]."' and `condition`=2;";
									$result5 = mysqli_query($conn, $query);
									$row5 = mysqli_fetch_row($result5);
									$query = "select * from house_main where house_id='".$row['house_id']."'";
									$result6 = mysqli_query($conn, $query);
									$row6 = mysqli_fetch_array($result6);

									//순서 찾기
									$position = 0;
									$query7 = "select * from user_movein_list where bed_id='".$row['bed_id']."' order by time ASC";
									$result7 = mysqli_query($conn, $query7);
									$i=0;
									while($row7 = mysqli_fetch_array($result7)){
										if($row7['email']==$_SESSION['id']){ $position = $i; break;}
										$i += 1;
									}

									//해당 방이 모집완료(만실) 인지 확인
									$query8 = "select * from house_beds where bed_id='".$row['bed_id']."'";
									$result8 = mysqli_query($conn, $query8);
									$row8 = mysqli_fetch_array($result8);
									
									$return = array();
                                    for($i=1;$i<9;$i++){
                                      $imagequery = "select * from house_main_image where email='".$row['house_id']."_".$i."'";
                                      $imageresult = mysqli_query($conn, $imagequery);
                                      if(mysqli_num_rows($imageresult)===1){
                                        $imagerow = mysqli_fetch_array($imageresult);
                                        array_push($return, $imagerow['img']);
                                      }
                                    }
								?>
								<div class="col-xs-12 col-sm-6 col-lg-4 grid-offer-col" >
									<div class="grid-offer" onclick="location.href='view_detail.html?house=<?=$row3[1]?>';">
										<div>

											<?if($row8['condition']=="1"){?>
												<!-- 방 모집완료일 때 사용 -->
												<div class="type-container complete-type-container">
													<div class="transaction-type complete-transaction-type">모집완료</div>
												</div>
												<!-- 방 모집완료일 때 사용 -->
											<?}?>

											<div class="grid-offer-photo">
												<img src="<?if(sizeof($return)>0){ echo 'server/'.$return[0]; } else{echo 'server/houses/noimg.jpg';}?>" alt="" style="height:140px"/>
												<div class="type-container">
													<div class="transaction-type"><?=$position+1?>번째</div>
												</div>
											</div>
											<div class="grid-offer-text" style="padding:15px 10px 15px 10px;">
												<div class="grid-offer-h4" style="margin-bottom:5px;"><h4 class="grid-offer-title"><i class="fa fa-home grid-offer-localization"></i>&nbsp;<?=$row6['house_title']?></h4></div>
												<div class="clearfix"></div>
												<span>총인원(정원) : <?=$row2[0]?>명</span>
												<span>사용가능한 방 갯수 : <?=$row6['number_of_rooms']?>개</span>
												<div class="clearfix"></div>
											</div>
											<div class="price-grid-cont">
												<div class="grid-price-label pull-left">가격 : </div>
												<div class="grid-price pull-right">
													<?=$row2[2]?>$ - <?=$row2[1]?>$
												</div>
												<div class="clearfix"></div>
											</div>
											<div class="grid-offer-params" style="display:block">
												<div class="grid-rooms" style="font-size:14px; width:100%; text-align:center; padding:2px 0px 2px 0px;">
													<?if($row5[0]!=null){?>
													<!-- 방이 입주가능이면... -->
													<span class="glyphicon glyphicon-ok-circle" aria-hidden="true">&nbsp;<?=$row5[0]?>부터 입주가능</span>
													<!-- 방이 입주가능이면... -->
													<?} else{?>
													<!-- 방이 만실이면... -->
													<span class="glyphicon glyphicon glyphicon-remove-circle" aria-hidden="true">&nbsp;만실</span>
													<!-- .방이 만실이면... -->
													<?}?>
												</div>
											</div>
										</div>
									</div>
									<?
									    $newQuery = "select * from request_movein_list where email='".$_SESSION['id']."' and bed_id='".$row['bed_id']."'";
									    $newResult = mysqli_query($conn, $newQuery);
									    if(mysqli_num_rows($newResult)===1){
									    $newRow = mysqli_fetch_array($newResult);
									    $roomidQuery = "select * from house_beds where bed_id='".$row['bed_id']."'";
                                        $roomidResult = mysqli_query($conn, $roomidQuery);
                                        $roomidRow = mysqli_fetch_array($roomidResult);
                                        $personQuery = "select * from house_rooms where room_id='".$roomidRow['room_id']."'";
                                        $personResult = mysqli_query($conn, $personQuery);
                                        $personRow = mysqli_fetch_array($personResult);
                                        $add = explode($roomidRow['room_id']."_",$row['bed_id']);
									?>
                                            <div style="background-color:#3b5998; color:white;font-size:17px;font-weight:bold;text-align:center;display:block; clear:both;cursor:pointer; position:relative; top:-1px" onclick="javascript:accept(<?=$newRow['idx']?>,'<?=$newRow['date']?>',<?=$personRow['person']?>,<?=$add[1]?>)">
                                                <p style="padding:9px 0px;margin:0px">입주제안 도착</p>
                                            </div>
                                    <?
                                        }
                                    ?>
								</div>
								<?}?>

								</div>
						</div>
						
                        
                        <script>
                            function accept(idx,param, param2, param3){
                                $(".modal-date").text(param);
                                $(".modal-room").text(param2);
                                $(".modal-add").text(param3);
                                $(".accept-yes").attr("value",idx);
                                $("#accept-modal").modal("show");
                            }
                            $(".accept-yes").on("click",function(){
                                $.ajax({
										url:"server/sendMessage.php",
										type:"POST",
										data:{
											target : $(".accept-yes").attr("value"),
											condition: "accept"
										},
										success: function(data){
											swal({
                                              title: "전달 성공!",
                                              text: "감사합니다! 운영자에게 입주의사를 전달하였습니다. 연락을 기다려주세요!",
                                              type: "success",
                                              confirmButtonColor: "#DD6B55",
                                              confirmButtonText: "확인",
                                              closeOnConfirm: false
                                            },
                                            function(){
                                              location.reload();
                                            });
										},
										error: function(){
											swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
										}
									});
                            });
                            $(".accept-no").on("click",function(){
                                $.ajax({
										url:"server/sendMessage.php",
										type:"POST",
										data:{
											target : $(".accept-yes").attr("value"),
											condition: "decline"
										},
										success: function(data){
											swal({
                                              title: "전달 성공!",
                                              text: "감사합니다! 전달되었습니다.",
                                              type: "success",
                                              confirmButtonColor: "#DD6B55",
                                              confirmButtonText: "확인",
                                              closeOnConfirm: false
                                            },
                                            function(){
                                              location.reload();
                                            });
										},
										error: function(){
											swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
										}
									});
                            });
                        </script>

						<div class="col-xs-12 col-md-3 col-md-pull-9"  style="padding-left:5px;">
							<div class="sidebar-left">
								<h3 class="sidebar-title">입주신청</h3>
								<div class="title-separator-primary" style="margin-top: 10px;"></div>

								<div class="profile-info margin-top-30">
									<div class="profile-info-title negative-margin pull-left">
										<?
                                            $profileQuery = "select * from user_profile where email='".$_SESSION['id']."'";
                                            $profileResult = mysqli_query($conn, $profileQuery);
                                            if(mysqli_num_rows($profileResult)==1){
                                                $profileRow = mysqli_fetch_array($profileResult);
                                                echo '<img src="'.$profileRow['img'].'" alt="" class="img-responsible pull-left" style="height:83px"/>';
                                            }
                                            else echo '<img src="images/comment-photo2.jpg" alt="" class="img-responsible pull-left" style="height:83px"/>';
                                        ?>
									</div>
									<div class="profile-info-text pull-left">
										<p class="subtitle-margin">
											<?=$_SESSION['name']?>
										</p>
										<br>
										<p class="subtitle-margin">
											<?=$_SESSION['id']?>
										</p>
									</div>
									<div class="clearfix"></div>
								</div>

								<div class="profile-info margin-top-30" style="padding:0px;">
									<div class="profile-info-title negative-margin">새로 등록된 하우스</div>
								</div>

								<?
									 include 'server/dbconnect.php';
									 $query = "select * from house_main order by register_time desc limit 6,3";
									 $result = mysqli_query($conn, $query);
									 $cnt= 0 ;
									 $index = 0;
									 while($row = mysqli_fetch_array($result)){
								?>
									<div class="sidebar-featured-cont margin-top-0">
										<div class="sidebar-featured">
											<a class="sidebar-featured-image" href="#">
												<?
													$return = array();
                                                        for($i=1;$i<9;$i++){
                                                          $imagequery = "select * from house_main_image where email='".$row['house_id']."_".$i."'";
                                                          $imageresult = mysqli_query($conn, $imagequery);
                                                          if(mysqli_num_rows($imageresult)===1){
                                                            $imagerow = mysqli_fetch_array($imageresult);
                                                            array_push($return, $imagerow['img']);
                                                          }
                                                        }
												?>
												<img src="<?if(sizeof($return)>0){ echo 'server/'.$return[0]; } else{echo 'server/houses/noimg.jpg';}?>" alt="" height="80"/>

												<div class="sidebar-featured-type">
													<div class="sidebar-featured-estate" style="width:30px;">NEW</div>
													<!-- 주택유형 -->
												</div>
											</a>
											<div class="sidebar-featured-title"><a href="view_detail.html?house=<?=$row['house_id']?>"><?= $row['address'] ?></a></div>
											<!--주소 -->
											<div class="clearfix"></div>
										</div>
								<?

									}
								?>


								    </div>

							</div>
						</div>

					</div>
				</div>
			</section>

			<!--small footer-->
			<?include("config/footer.html")?>

		</div>

		<!-- Move to top button -->

		<div class="move-top">
			<div class="big-triangle-second-color"></div>
			<div class="big-icon-second-color"><i class="jfont fa-lg">&#xe803;</i></div>
		</div>

		<!--로그인, 회원가입, 비밀번호 찾기-->
		<?include("config/user.html")?>
		<!--sweetalert2-->
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">
		<script src="js/sweetalert.min.js"></script>

		<!-- jQuery  -->
		<script type="text/javascript" src="js/jQuery/jquery.min.js"></script>
		<script type="text/javascript" src="js/jQuery/jquery-ui.min.js"></script>

		<!-- Bootstrap-->
		<script type="text/javascript" src="bootstrap/bootstrap.min.js"></script>

		<!-- Google Maps -->
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDfDCV5hXiPamCIT8_vwGXuzimLQ9MF76g&amp;sensor=false&amp;libraries=places"></script>

		<!-- plugins script -->
		<script type="text/javascript" src="js/plugins.js"></script>

		<!-- template scripts -->
		<script type="text/javascript" src="mail/validate.js"></script>
		<script type="text/javascript" src="js/apartment.js"></script>

	</body>

	</html>
