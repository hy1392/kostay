<?php
	session_start();
	if(!isset($_SESSION['flag'])) echo "<script>location.href='index.html'</script>";
	include "server/dbconnect.php";
?>
	<!DOCTYPE html>
	<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Kostay</title>
		<meta name="keywords" content="Download, Apartment, Premium, Real Estate, HMTL, Site Template, property, mortgage, CSS" />
		<meta name="description" content="Download Apartment - Premium Real Estate HMTL Site Template" />
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<link rel="icon" href="favicon.ico" type="image/x-icon">

		<!-- Bootstrap -->
		<link rel="stylesheet" href="bootstrap/bootstrap.min.css">
		<!-- Font awesome styles -->
		<link rel="stylesheet" href="apartment-font/css/font-awesome.min.css">
		<!-- Custom styles -->
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,500,500italic,700,700italic&amp;subset=latin,latin-ext'>
		<link rel="stylesheet" type="text/css" href="css/plugins.css">
		<link rel="stylesheet" type="text/css" href="css/apartment-layout.css">
		<link rel="stylesheet" type="text/css" href="css/custom.css">
		<link id="skin" rel="stylesheet" type="text/css" href="css/apartment-colors-blue.css">
		
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAxwBuJWDjuX_iABj5vaPO5ljMD_nGflB4&amp;libraries=places"></script>

		<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style media="screen">
        .adv-search-section {
            height: 40vh;
        }
        .item-row{
            border:  1px solid rgba(226, 226, 226, 0.72);
            cursor: pointer;
            margin-bottom: 20px;
        }
        .list-img{
            width: 40% !important;
            height: auto;
            margin: 5px;
            max-width: 25px;
            max-height: 25px;
        }
        .icon-contanier{
            color: white;
            font-size: 1.5em;
        }
        .resize-icon-container{
            display: inline;
            position: relative;
        }

        @media (max-width: 600px) {
            .resize-icon-container{
            left: 25%;
        }
        }


        .icon-contanier span{
            margin-left: 10%;
            font-size: 1em;
            margin-top: 3px;
            position: relative;
            top: 3px;
        }
        h5{
            margin-bottom: 25px;
        }
    </style>
	</head>

	<body>
		<div class="loader-bg"></div>
		<div id="wrapper">

			<!-- Page header -->
			<header>
				
				<!-- /.Page top-bar-wrapper -->

				<?include("config/mypage_navbar.html");?>
			</header>

			<section class="section-light section-top-shadow">
				<div class="container">
					<div class="row">
						<div class="col-xs-12">
							<div class="row">
								<?
                                    $alarmQuery = "select * from alarm where alarm_id='".$_GET['alarm']."'";
                                    $alarmResult= mysqli_query($conn, $alarmQuery);
                                    $alarmRow = mysqli_fetch_array($alarmResult);
                                     $query_house = array();
                                    $query_room = array();

                                      if($alarmRow['gender']!=null) array_push($query_house, " `gender` = '".$alarmRow['gender']."' ");

                                      if($alarmRow['house_type']!=null){
                                        if($alarmRow['house_type']==0){
                                          array_push($query_house, " (`house_type`  = '1' or `house_type` = '2')");
                                        }
                                        else if($alarmRow['house_type']) array_push($query_house, " `house_type` = '1'");
                                        else if($alarmRow['house_type']) array_push($query_house, " `house_type` = '2'");
                                      }

                                      if($alarmRow['type']!=null){
                                        if($alarmRow['type']==4){
                                            array_push($query_house, " `type` like '%4%'");
                                        }
                                        else if($alarmRow['type']==1) array_push($query_house, " `type` like '%1%'");
                                        else if($alarmRow['type']==2) array_push($query_house, " `type` like '%2%'");
                                        else if($alarmRow['type']==3) array_push($query_house, " `type` like '%3%'");
                                      }

                                    if($alarmRow['min_rent']!=null){
                                        $low=$alarmRow['min_rent'];
                                        $high=$alarmRow['max_rent'];
                                        array_push($query_house, " (`min_rent` >= ".$low." and `max_rent` <= ".$high.")");
                                    }


                                      if($alarmRow['park']!=null){
                                        if($alarmRow['park']=="0"){}
                                        else if($alarmRow['park']=="1") array_push($query_house, " `park` = 1");
                                      }


                                      if($alarmRow['date']!=null){
                                          if($alarmRow['date_condition']==0){}
                                          else if($alarmRow['date_condition']==1) array_push($query_house, " `date` <= '".$alarmRow['date']."'");
                                          else if($alarmRow['date_condition']==2) array_push($query_house, " `date` >= '".$alarmRow['date']."'");  
                                      }


                                      if($alarmRow['person']!=null) {
                                        if($alarmRow['person']==0){
                                        }
                                        elseif($alarmRow['person']==4){
                                          array_push($query_room, " `person` >= ".$alarmRow['person']." ");
                                        }
                                        else{
                                          array_push($query_room, " `person` = ".$alarmRow['person']." ");
                                        }
                                      }


                                    array_push($query_house, " ad='1'");


                                    $origin="";
                                    $origin_condition="";

                                    if(($alarmRow['alarm_param']!=null || $alarmRow['alarm_loc']!=null)){
                                      if($alarmRow['alarm_loc']==1){
                                        $origin = $alarmRow['address'];
                                        $origin_condition = $alarmRow['alarm_param'];
                                      }
                                      else if($alarmRow['alarm_loc']==2){
                                        $origin = $alarmRow['address'];
                                        $origin_condition = 8;
                                      }
                                      else if($alarmRow['alarm_loc']==3){
                                        $origin = $alarmRow['address'];
                                        $origin_condition = $alarmRow['alarm_param'] * 5;
                                      }
                                    }

                                    $query2 = "select house_id from search ";
                                    $query_count = "select count(*) from search";
                                    for($i=0; $i<count($query_house);++$i){
                                      if($i==0) {
                                        $query2 .= " where ";
                                        $query_count .= " where ";
                                      }
                                      else{
                                        $query2 .= " and ";
                                        $query_count .= " and ";
                                      }
                                      $query2 .= $query_house[$i];
                                      $query_count .= $query_house[$i];
                                    }

                                    $query2 .=  " order by register_time DESC";
                                    $query_count .=  " order by register_time DESC";

                                    $result2 = mysqli_query($conn, $query2);
                                    $result_count = mysqli_query($conn, $query_count); 


                                    $index=0;
                                    while($row2=mysqli_fetch_array($result2)){
                                      $query_second = "select * from search";
                                      $second_result = mysqli_query($conn, $query_second);
                                      $second_row=mysqli_fetch_array($second_result);
                                    ?>
                                    <script type="text/javascript">
								  var geocoder;
								  var origin;
								  var latlng;
                                    var search_id;
                                    
                                    var originA = '<?=$origin?>';
                                    var destinationA = '<?= $second_row["address"] ?>';

                                  

								  geocoder =  new google.maps.Geocoder();
								  geocoder.geocode({'address':'<?=$origin?>'}, function(results, status) {

								          if (status == google.maps.GeocoderStatus.OK)
								          {
								            for(var i=0;i<results.length;i++)
								            {
								              origin = new google.maps.LatLng(results[i].geometry.location.lat(), results[i].geometry.location.lng());
								              var destination = "<?= $second_row['address'] ?>";
								              var service = new google.maps.DistanceMatrixService();
								              service.getDistanceMatrix(
								              {
								                  origins: [origin],
								                  destinations: [destination],
								                  travelMode: google.maps.TravelMode.DRIVING,
								                  unitSystem: google.maps.UnitSystem.METRIC,
								                  avoidHighways: false,
								                  avoidTolls: false
								              },
								                  callback
								              );
								            }
								          }
								          else{
								            //alert("Geocode was not successful for the following reason: " + status);
								          }
								      });

								      //var origin = new google.maps.LatLng(55.930385, -3.118425),
								      //var origin = new google.maps.LatLng(37.335887, 126.584063),
								      function callback(response, status) {
								        /*
								        var orig = document.getElementById("orig"),
								            dest = document.getElementById("dest"),
								            dist = document.getElementById("dist");
								        */

								        if(status=="OK"){
								          /*
								          dest.value = response.destinationAddresses[0];
								          orig.value = response.originAddresses[0];
								          */
								          //dist.value = response.rows[0].elements[0].distance.text;
                                            var distance = new Array();
                                            try{
                                                distance = response.rows[0].elements[0].distance.text.split('');      
                                            }catch(exception){
                                                distance.push('1000');
                                            }
								          
								          var origin_condition = "<?=$origin_condition?>";
								          
								          if("<?=$_SESSION['id']?>" == null){
								            search_id = 'guest';
								          }
								          else{
								            search_id = "<?=$_SESSION['id']?>";
								          }
								          if(origin_condition >= distance[0]){
								            //alert("<?=$second_row['address']?>");
								            $.ajax({
								              url:"server/search_result.php",
								              type:"POST",
								              data:{
								                house_id:"<?=$row['house_id']?>",search_id:search_id,limit:"<?=$origin_condition?>", distance : distance[0],condition:"add"
								              },
								              success: function(data){
								              },
								              error: function(){
								              }
								            });
								          }
								        } else {
								          //alert("ERROR");
								          //alert("Error: " + status);
								        }
								      }
								      </script>
                                          <?
                                        }
                                      ?>


                                    <?
                                        if($_SESSION['id']==null) $search_id="guest";
                                        else $search_id = $_SESSION['id'];
                                        $final_count_query = "select count(*) from search_result where username='".$search_id."'";
                                        $final_count_result = mysqli_query($conn, $final_count_query);
                                        $final_count_row = mysqli_fetch_array($final_count_result);
                                    ?>
								<div class="col-xs-12">
									<h3>총 <?=$final_count_row[0]?>개의 하우스가 등록되었습니다.</h3>
								</div>
								<div class="col-xs-12">
									<div class="title-separator-primary"></div>
								</div>
							</div>
							<div class="row list-offer-row">
								<div class="col-xs-12">

									<!-- Item -->
									<?
									    if($_SESSION['id']==null) $search_id="guest";
										else $search_id = $_SESSION['id'];
									    $query = "select * from search_result where username='".$search_id."'";

									  $result = mysqli_query($conn, $query);
									 while($row = mysqli_fetch_array($result)){
										 $query = "select sum(person), max(rent), min(rent) from house_rooms where house_id='".$row['house_id']."'";
										 $result2 = mysqli_query($conn, $query);
										 $row2 = mysqli_fetch_row($result2);
										 $query = "select room_id from house_rooms where house_id='".$row['house_id']."'";
										 $result3 = mysqli_query($conn, $query);
										 $row3 = mysqli_fetch_row($result3);
										 $query = "select count(*) from house_beds where room_id like '".$row['house_id']."_%' and `condition`!=3;";
										 $result4 = mysqli_query($conn, $query);
										 $row4 = mysqli_fetch_row($result4);
										 $roomIdQuery = "select room_id from house_rooms where house_id='".$row['house_id']."';";
										 $roomIdResult = mysqli_query($conn, $roomIdQuery);
										 $roomCondition="";
										 $isFirst=true;
										 while($roomIdRow = mysqli_fetch_array($roomIdResult)){
											 if($isFirst){
												 $isFirst=false;
												 $toAdd="room_id = '".$roomIdRow[0]."'";
												 $roomCondition.=$toAdd;
											 }
											 else{
												 $toAdd="or room_id = '".$roomIdRow[0]."'";
												 $roomCondition.=$toAdd;
											 }
										 }
										$vacantQuery = "select min(vacant) from house_beds where (".$roomCondition.") and `condition`=2;";
										$vacantResult = mysqli_query($conn, $vacantQuery);
										$vacantRow = mysqli_fetch_array($vacantResult);
										$vacantQuery2 = "select * from house_beds where (".$roomCondition.") and `condition`=3;";
										$vacantResult2 = mysqli_query($conn, $vacantQuery2);
										$titleQuery="select house_title,number_of_rooms, facilities,number_of_toilet from house_main where house_id='".$row['house_id']."'";
										$titleResult=mysqli_query($conn,$titleQuery);
										$titleRow = mysqli_fetch_array($titleResult);
										

                                        $return = array();
                                        for($i=1;$i<9;$i++){
                                          $imagequery = "select * from house_main_image where email='".$row['house_id']."_".$i."'";
                                          $imageresult = mysqli_query($conn, $imagequery);
                                          if(mysqli_num_rows($imageresult)===1){
                                            $imagerow = mysqli_fetch_array($imageresult);
                                            array_push($return, $imagerow['img']);
                                          }
                                        }
									?>

									<div class="row item-row" name="<?=$row['house_id']?>">
										<div class="col-sm-12 col-md-4 col-lg-3"  style="padding:0px;">
											<div class="list-offer-photo height-100">
												<img src="<?if(sizeof($return)>0){ echo 'server/'.$return[0]; } else{echo 'server/houses/noimg.jpg';}?>" alt="" style="height:182px; width:270px" />

												<div class="col-xs-12 icon-contanier" style="background-color:black; position:absolute; bottom:0px;">
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/icons/w_master.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$row2[0]?></span>
														</div>
													</div>
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/rooms-icon.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$titleRow['number_of_rooms']?></span>
														</div>
													</div>
													<div class="col-xs-4">
														<div class="resize-icon-container">
															<img class="list-img" src="images/icons/w_toilet.png" alt=""><span class="list-span" style="font-size:0.8em"><?=$titleRow['number_of_toilet']?></span>
														</div>
													</div>
												</div>

											</div>
										</div>
                                        
                                        <style>
                                            .desc-default-option-title{
                                                    margin: 0px;
                                                    display: block;
                                                    white-space: nowrap;
                                                    overflow: hidden;
                                                    text-overflow: ellipsis;
                                                    height: 50px;
                                                    font-weight: bold;
                                            }
                                            .desc-default-option{
                                                    margin: 0px;
                                                    display: -webkit-box; 
                                                    -webkit-line-clamp: 3;
                                                    text-overflow: ellipsis; 
                                                    overflow: hidden;
                                                    -webkit-box-orient: vertical;
                                            }
                                        </style>
                                        
										<div class="col-sm-12 col-md-5 col-lg-7" style="padding:0px;">
											<div class="" style="padding-top:5px;">
												<div class="clearfix"></div>

												<div class="row">
													<div class="list-offer-h4 col-sm-12 col-md-12">
														<!--<strong><i class="fa fa-home list-offer-localization" style="font-size:1.4em;"></i></strong>-->
														<h4 class="list-offer-title title-default  desc-default-option-title" style="margin-bottom:20px !important;"><?=$titleRow['house_title']?></h4>
														<h5 class="desc-default desc-default-option" style="margin:0px"><?=$titleRow['facilities']?></h5>
													</div>
												</div>
											</div>
										</div>

										<div class="col-sm-12 col-md-3 col-lg-2" style="padding:0px">
											<table style="width:100%; height:100%">
												<tr>
													<td>
														<div style="background-color:rgb(242,242,242); cursor:pointer; width:100%; height:50%;padding: 10px;">
															<p class="title-default" style="font-size:1.5em; font-weight:bold; color:black; width100%; text-align:center; margin-bottom:0px;"><?=$row2[2]?>~<?=$row2[1]?>$</p>
														</div>
													</td>
												</tr>
												<tr>
													<td>
														<div style="background-color:rgb(242,242,242); cursor:pointer; width:100%; height:50%;padding: 10px; <? if($vacantRow[0]!=null){echo 'border:1px solid black';}?>">
															<p style="font-size:1.3em; color:black; width100%; text-align:center; margin-bottom:0px;"><? if(mysqli_num_rows($vacantResult2)>0){echo"&nbsp";}else if($vacantRow[0]!=null){echo $vacantRow[0]."~";}else{echo "&nbsp;";}?></p>
														</div>
													</td>
												</tr>
												<tr>
													<td>
														<div style="background-color:rgb(0,0,0); cursor:pointer; width:100%; height:50%;padding: 10px;">
															<p class="title-default" style="font-size:1.5em; font-weight:bold; color:white; width100%; text-align:center; margin-bottom:0px;"><? if(mysqli_num_rows($vacantResult2)>0){echo"공실";} else if($vacantRow[0]!=null){echo "공실예정";}else if($row4[0]==$row2[0]){echo "만실";} else{ echo "공실";}?></p>
														</div>
													</td>
												</tr>
												<tr>
													<td>
														<div style="background-color:rgb(55, 151, 221); cursor:pointer; width:100%; height:50%;padding: 10px;" name="<?=$row['house_id']?>" onclick="wish(this)">
															<p class="title-default" style="font-size:1.5em; font-weight:bold; color:white; width100%; text-align:center; margin-bottom:0px;"><i class="fa fa-heart-o fa-lg"></i>&nbsp;찜하기</p>
														</div>
													</td>
												</tr>
											</table>

										</div>
									</div>


									<!-- .Item -->
									<?
									    }
									   
									?>
									<script>
									var canMove = true;
										function wish(param){
											$.ajax({
												url:"server/wish_list.php",
												type:"POST",
												data:{
													target:$(param).attr("name")
												},
												success: function(data){
													if(data=="하우스가 찜리스트에 추가되었습니다."){
                                                        swal({
                                                          title: "추가성공",
                                                          text: "감사합니다. 찜리스트에 추가되었습니다.",
                                                          imageUrl: "images/naro_sub_ani.gif"
                                                        });
                                                    }
													else swal("에러!",data,"warning");
												},
												error: function(){
													swal("에러 발생!","잠시후 다시 시도해 주세요.","error");
												}
											});
											canMove = false;
										}
									</script>
							<div class="offer-pagination margin-top-30">
								<?
								$query = "select * from house_main";
								$result = mysqli_query($conn, $query);
								$count = mysqli_num_rows($result);
								if($count>0){
								?>
								<a href="#" class="prev"><i class="jfont">&#xe800;</i></a>
								<?for($i=1;$i<($count/8)+1;++$i){?>
								<a><?=$i?></a>
								<?}?>
								<a href="#" class="next"><i class="jfont">&#xe802;</i></a>
								<?}?>
								<div class="clearfix"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
			</section>

			<!--small footer-->
			<?include("config/footer.html")?>
		</div>

		<!-- Move to top button -->

		<div class="move-top">
			<div class="big-triangle-second-color"></div>
			<div class="big-icon-second-color"><i class="jfont fa-lg">&#xe803;</i></div>
		</div>

		<!--로그인, 회원가입, 비밀번호 찾기-->
		<?include("config/user.html")?>
		<!--sweetalert2-->
		<link rel="stylesheet" type="text/css" href="css/sweetalert.css">
		<script src="js/sweetalert.min.js"></script>

		<!-- jQuery  -->
		<script type="text/javascript" src="js/jQuery/jquery.min.js"></script>
		<script type="text/javascript" src="js/jQuery/jquery-ui.min.js"></script>

		<!-- Bootstrap-->
		<script type="text/javascript" src="bootstrap/bootstrap.min.js"></script>

		<!-- Google Maps -->
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDfDCV5hXiPamCIT8_vwGXuzimLQ9MF76g&amp;sensor=false&amp;libraries=places"></script>

		<!-- plugins script -->
		<script type="text/javascript" src="js/plugins.js"></script>

		<!-- template scripts -->
		<script type="text/javascript" src="mail/validate.js"></script>
		<script type="text/javascript" src="js/apartment.js"></script>
		<script>
            $(".list-offer-right-large").on("click", function() {
			var loc = "view_detail.html?house=" + $(this).attr("name");
			if(canMove) {location.href = loc; canMove = true;}
			else canMove = true;
		});
		$(".item-row").on("click", function() {
			var loc = "view_detail.html?house=" + $(this).attr("name");
			if(canMove) {location.href = loc; canMove = true;}
			else canMove = true;
		});
        </script>

	</body>

	</html>
